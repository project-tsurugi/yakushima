# Yakushima design doc

## この文書について
- Concurrent Tree Yakushima の概要
- 現状の ASIS を示したものであり、適宜更新する。

## 仕様
- Masstree をベースとした Concurrent tree.
- ストレージを複数制御することが可能であり、ストレージ間でキー空間は分かれている。
- キー・バリューは可変長のバイナリ列であり、その型は Yakushima において関知しない。
- キー一つに対して、バリューを一つ持つ。
  - キー：バリューを N:1 にしたければ、一つのオブジェクトのディープコピーやシャローコピーを必要に応じてそれぞれのキーに付帯させて挿入すればよい。
  - キー：バリューを 1:N にしたければ、バリューはバイナリ列としてN個のオブジェクトを連結すればよい。
- 全ての操作は明示的なキーを介して行う。
- yakushima が扱えるキー長は 35KB までであるとし、それ以上のキー長を扱うことは未定義動作とする。

## design concept
- header only library であり、 yakushima/include/kvs.h をインクルードするだけで利用可能である。
- 最大並行ワーカー数はビルド時のオプションによって決める。
  - それを前提にすることで、ロックフリー技術によって性能向上を実現した。
- Optimistic lock coupling 技術を用いて、 Masstree には無い atomic scan 機構を実現した。
- リトライロジックを Masstree より効率化している。

## Yakushima 起動・終了 API
- `init`
  - yakushima を起動する。
- `fin`
  - yakushima を終了する。

## ストレージ操作 API
- `create_storage`
  - ストレージを作成する。
- `delete_storage`
  - ストレージを削除する。
- `find_storage`
  - 特定のストレージが存在するか確認する。
- `list_storage`
  - ストレージの一覧を照会する。

## セッション操作 API
- `enter`
  - あるタスクにおいて、データ操作 API を実施する前に、セッションを開き、実行時情報等の割り当てを行う。セッションを開いている間の読み込みによって観測されうるデータ領域は GC から保護される。
- `leave`
  - あるタスクにおいて、データ操作 API の仕様を終了することを宣言する。 `leave` して以降、する以前にデータの読み込み操作で観測したデータ領域は GC 等によって不正なものになっているかもしれない。`leave` の実施によって GC がトリガーされたり、`enter` の処理コストが存在したりするため、ベンチマーク中は `leave` しないことを推奨する。非ベンチマーク中は一定時間起きに GC の機会を設けるため `enter`, `leave` を再実施することを推奨する。

## データ操作 API
- 読み込み
  - 単一読み込み
    - `get`
      - あるキーに対応するエントリを読み込む。
  - 範囲読み込み
    - `scan`
      - ある範囲におけるエントリを読み込む。
- 書き込み
  - `put`
    - あるキーに対応するエントリの挿入・更新を試みる。
  - `remove`
    - あるキーに対応するエントリの削除を試みる。

## クリーンアップ API
- `destroy`
  - 全てのストレージ・エントリの削除を試みる。